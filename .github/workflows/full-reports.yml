name: Build Git Reports

on:
  workflow_dispatch:
  push:
      branches: [ "main" ]
  schedule:
      - cron: "15 4 * * *"

defaults:
  run:
    shell: pwsh


jobs:

  Pre-Build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 888888

    - name: BUILD Git.Summary.Tests
      shell: bash
      run: |
        set -eu; set -o pipefail
        script=https://raw.githubusercontent.com/devizer/test-and-build/master/install-build-tools-bundle.sh; (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash >/dev/null
        Say --Reset-Stopwatch
        Say "CPU: $(Get-CpuName)"
        
        Say "Build fx-dependent Tests"
        cd Git.Summary.Tests
        try-and-retry dotnet restore
        try-and-retry dotnet build -c Release -f net8.0 -o "${{ github.workspace }}/bin/Git.Summary.Tests"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: 'Binaries'
        path: bin
        # path: "${{ runner.temp }}/Artifacts/**/**"
          
  
  BuildReport:

    timeout-minutes: 45
    needs: Pre-Build
    strategy:
      fail-fast: false
      matrix:
        VMIMAGE: [
           'windows-latest',
           'macos-15',
           'ubuntu-latest'
        ]
        Repo: [
           'https://github.com/devizer/Universe.CpuUsage',
           'https://github.com/nunit/nunit',
           'https://github.com/dotnet/efcore'
        ]

    runs-on: ${{ matrix.VMIMAGE }}

    env:
      PS1_TROUBLE_SHOOT: On


    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 888888

    - name: Download Pre-Build artifacts
      uses: actions/download-artifact@v4
      with:
         path: '${{ github.workspace }}/Binaries'
         merge-multiple: true # just one artifact
         name: Binaries


    # Add  MSBuild to the PATH: https://github.com/microsoft/setup-msbuild
    # - name: Setup MSBuild.exe
    #  uses: microsoft/setup-msbuild@v2

    - name: Measure Install-Module
      if: ${{ true }}
      run: |
        iex ((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/devizer/Universe.SqlServerJam/master/SqlServer-Version-Management/Install-SqlServer-Version-Management.ps1'))
        Say "CPU: $(Get-Cpu-Name)"

    - name: RUN Git.Summary.Tests
      id: run
      run: |
        $repoShortName = [System.IO.Path]::GetFileName("${{ matrix.Repo }}");
        $ENV:TEST_GIT_LOCAL_REPO_FOLDER = Combine-Path "$HOME" "Repo-$repoShortName";
        & git clone --quiet "${{ matrix.Repo }}" "$($ENV:TEST_GIT_LOCAL_REPO_FOLDER)"
        $ENV:GIT_TRACE_FOLDER = Combine-Path "${{ github.workspace }}" "Traces"
        $__ = New-Item -Type Directory -Name "$($ENV:GIT_TRACE_FOLDER)" -EA SilentlyContinue | out-null

        Say "Repo Short Name: '$repoShortName'"
        Say "LOCAL REPO: '$($ENV:TEST_GIT_LOCAL_REPO_FOLDER)'"
        Say "Traces: '$($ENV:GIT_TRACE_FOLDER)'"

        echo "repo_short_name=$repoShortName" >> $GITHUB_ENV
        echo "::set-output name=artifact::$($repoShortName)"
        # echo "artifact=$($repoShortName)" >> "$GITHUB_OUTPUT"
        cd Binaries
        cd Git.Summary.Tests
        dotnet test Git.Summary.Tests.dll *| tee "$($ENV:GIT_TRACE_FOLDER)/Test-Output.Log"


    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: '${{ github.job }} for ${{ steps.run.outputs.artifact }} on ${{ matrix.VMIMAGE }}'
        path: '${{ github.workspace }}'


          
  Combine:
    runs-on: windows-latest
    needs: BuildReport
    if: always()
    timeout-minutes: 30
    steps:

    - name: Download all workflow run artifacts
      uses: actions/download-artifact@v4
      with:
         path: 'C:\Artifacts'

    - name: 'Repack C:\Artifacts'
      run: |
        cd C:\Artifacts
        $directories = @(Get-ChildItem -Recurse | ? { $_.PSIsContainer } | % { $_.FullName } | ? { -not ("$_" -match "Trace") } )
        echo "TO DELETE:"
        echo $directories
        $directories | % { Remove-Item -Recurse -Force $_ -EA SilentlyContinue | out-null }

        & 7z a "C:\Artifacts\Combined Git.Summary.Tests.7z" "-mx=9" "-ms=on" "-mqs=on" "-sdel"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      # if: always()
      with:
        name: 'Combined Git.Summary.Tests'
        path: 'C:\Artifacts\Combined Git.Summary.Tests.7z'
          

